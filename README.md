# Multilayer_dFC_modelling
Pablo Mallaroni p.mallaroni@maastrichtuniversity.nl 

Code serves the purpose to look at whole brain static modularity and dynamic FC integ/seg as ^suggested^ by 
https://www.nature.com/articles/s41591-022-01744-z where code is not available
Approach seems consistent with:
https://www.nature.com/articles/s41467-020-15631-z

Feel try to try on any of your data for replication and check the code.
These scripts were written to account for potential variable roi numbers per subject.
Thus, works with cells of subject x session containing timeseries x roi data as input to step 1

The idea is to have consistent code for this kind of approach so please try on your stuff
If you have suggestions for better sliding windows please feel free to branch and debug

TBD: step 5 with plots and stats (depends on your design):
but you can treat step4  as a net x net ttest 
and step 2 q_norm result as a single array of sub x cond normalised q_modularity values

# Purpose
step_1 :  N × N × T matrix of x volume-sliding windows (depends on scan length and TR  with 50% overlap. This window size is typical for estimating dynamic FC with fMRI<br />
step_2_multilayer: The multilayer modularity estimation generates an N × T matrix where each element represents the community assignment of each ROI at each layer (time window). From this, the flexibility metric, f, can be simply calculated as the number of times an ROI changes its community allegiance, given the number of observations:
                    Flexibility scores close to 0 represent rigid ROIs whose community allegiance is stable across time, scores close to 1 represent flexible ROIs whose community allegiance regularly changes (highly flexible). Network level flexibility scores were defined by the average flexibility of ROIs assigned to the given network
step2_static:       works on base "whole-brain" to define global modularity at a static level: The community structure or segregation between the brain’s functional networks, was measured by summarizing each FC matrix with a common Louvain-like community detection algorithm where the objective is to maximize the extent to which brain areas                        can be separated into nonoverlapping communities or modules. The modularity quality function score, tends to be high when the brain exhibits a high segregation between its functional networks (such as strong clusters of FC within brain networks/communities with weak FC to the rest of the brain).
                    Note: The modularity scores were generated 100 times and the partition with the largest modularity score was normalized by the mean modularity generated from 100 randomly rewired (shuffled) FC matrices). This common procedure was applied to account for the nondeterministic and near-degenerate partitions (solutions with                               differing but similar optimality) generated by Louvain algorithms and to account for modularity scores relating to the total sum of FC within the network66. This process was repeated independently for eachs sub and scan (requires permutations)
step2_multilayer    Simply: The multilayer modularity estimation generates an N × T matrix where each element represents the community assignment of each ROI at each layer (time window). From this, the flexibility metric, f, can be simply calculated as the number of times an ROI changes its community allegiance, given the number of                                observations (requires permutations)
Step4               Using the allegiance matrix, we then summarized how often ROIs either formed communities with ROIs from the same functional network (network recruitment) or formed communities with ROIs between different networks (between-network integration) across the partitions33. These functional cartography measures were then                              normalized against the mean values from 1,000 randomly shuffled ROI network assignments to account for differences in the number of regions in each network.  Finally, network recruitment and between-network integration scores were averaged at the network level using x predefined cortical networks


# Requirements:
denoised sub x ses cell with time x roi
Brain connectivity toolbox
Gen louvain toolbox

# Note: python or c++ would be more elegant (less parforing(
